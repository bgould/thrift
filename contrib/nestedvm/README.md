Pure Java build of the Thrift compiler based on NestedVM
========================================================

*Note: currently based on the 0.10.0 source tree, JAR should be bug-for-bug
compatible with the 0.10.0 release of the Apache Thrift compiler.*

This module builds the Thrift compiler as a pure Java JAR file that can be run
as a command line program or called from a Java application.  This is useful if
you want to distribute a cross-platform Thrift binary, and might be especially
useful in Java build tools like Ant and Maven.  Requires Java 7 or above.

Building:
---------

To build, you will need a working [NestedVM][1] installation.  The official 
NestedVM repository hosted by Adam Megacz will not work for this build; the 
toolchain includes an old version of GCC that is unusable for this purpose.  
Fortunately a kind hacker named Henry Wertz has made available some patches for
NestedVM that make it [possible to build with a modern version of GCC][2]. Note
that NestedVM is only required for building; the JAR file that is produced can
be used and distributed without any dependencies other than a Java 7+ JVM.

If you have Docker installed, you can try using the `docker/build.sh` script to
build the Thrift compiler JAR using a Docker image that already has the 
prerequisite NestedVM toolchain installed.  This is probably fastest/easiest
way to compile the JAR if it works for you.  Once the Docker build completes,
you can find the executable JAR as well as the source and javadoc JARs in the
`build/ant` folder (see below for usage instructions).

If you are not going to use Docker, perhaps the easiest way to grab a suitable
NestedVM source tree is to clone the repository below, which includes Henry
Wertz's patches as well as David Ehrmann's fixes for the UnixRuntime library 
that are necessary for  Thrift to compile and run properly (importantly,
proper handling the .rel.dyn section in Thrift's ELF file as well as bug fix
for the realpath syscall).

    cd /usr/local/src
    git clone https://github.com/bgould/nestedvm
    cd nestedvm
    git checkout tags/thrift-0.10.0
    make dist
    # grab a beverage and make a sandwich, the build will take a little while

*Note: on Debian, you may need to use `make dist CC=gcc-4.8 CXX=g++-4.8`;
see README in above repository for more detailed instructions*

Going forward the instructions will assume you have NestedVM installed at
`/usr/local/nestedvm`.  If you want to put it someplace else that is fine,
just substitute that path in the following the build steps.

Once you have a working installation of NestedVM, you may want to make sure
that you are able to build the Thrift compiler normally, perhaps like this:

    cd /usr/local/src/thrift && ./configure --disable-libs && make

If that works then you should be able to build the compiler with NestedVM.  If
it does not, refer to [Building From Source][3] to ensure that you have all of
the necessary prerequisites installed and configured.

Make sure that you set environment variables for your NestedVM and Java tools,
and then run the make file:

    export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64
    export nestedvm=/usr/local/nestedvm
    cd /usr/local/src/thrift/contrib/nestedvm
    make

*Note: by default, before compiling the build process will use the 
`git archive` command to create a zip file of the source at the HEAD of the
checked out branch; therefore you should be aware that any uncommitted changes
to the compiler source will not be reflected in the NestedVM build.*

If/when that completes successfully, you can test the build:

    java -jar build/ant/thrift-compiler-0.10.0.jar -help

If you want to include the compiler in your Java application you can just add
the JAR file or if you use Maven you could add the dependency to your local
repository after building:

    make install

Once it is in your local repository you can add it to your Maven project:

    <dependency>
      <groupId>org.apache.thrift</groupId>
      <artifactId>thrift-compiler</artifactId>
      <version>0.10.0</version>
    </dependency>

Command line usage:
-------------------

The JAR file is an executable JAR that takes all of the same options as the 
native Thrift compiler.  Some example:

      java -jar thrift-compiler-0.10.0.jar -help
    
	  java -jar thrift-compiler-0.10.0.jar -version
    
	  java -jar thrift-compiler-0.10.0.jar -gen java tutorial.thrift

Also, the JAR contains two additional commands for extracting the Thrift
support libraries for use with the code generated by the compiler.  To extract
a zip file of Thrift source tree, you can do the following:

    java -jar thrift-compiler-0.10.0.jar --export-source .

Or, to unzip as the source is extracted:

    java -jar thrift-compiler-0.10.0.jar --unzip-source .

API Usage:
----------

The JAR file provides a unified Java API for invoking the Thrift compiler,
either as a native executable or using the embedded NestedVM implementation. The
simplest way to do this from a Java program might be something like this:

    ThriftCompiler compiler = ThriftCompiler.newCompiler();
    final ExecutionResult result = compiler.execute(
        "-gen", "java:beans", new File("foobar.thrift").getAbsolutePath()
    );
    System.out.println("Code generation successful: " + result.successful());

When `ThriftCompiler.newCompiler()` is called, the implementation of the Thrift
compiler that is chosen is based on the following discovery steps:

 1. If a system property named `thrift.compiler.native` is defined, its value
    will dictate the implementation.  If it is set to `"true"`, a native Thrift
    executable is used.  In that case, the exact path to the binary can be
    specified via the system property `thrift.compiler.executable`. If
    `thrift.compiler.native` is set to any other non-null value, it will force
    the use of the embedded NestedVM implementation.
 2. If the `thrift.compiler.native` system property is not set, an attempt will
    be made to execute the command `thrift -version` (or  `thrift.exe -version`
    on Windows).  If that command is successful, the version string will be
    compared to the version string of the embedded NestedVM implementation.  If
    they match exactly, the native executable will be used instead of the
    embedded version (this is an optimization; the native executable not only
    runs faster, but the JVM implementation incurs a penalty the first time
    it is loaded because the class file is so large).
 3. If the above conditions are not met, the NestedVM implementation is used.

The above auto-discovery can be bypassed by using another variant of the
`newCompiler` method that takes a `java.util.Properties` argument.  As above,
the following properties can be specified:

  * `thrift.compiler.native` - Forces the use of native executable.  If not set,
    or if set to any value other than `"true"` the embedded Java implementation
    of the compiler will be used.<br/>
  * `thrift.compiler.executable` - If using native executable, this optional 
    property can provide a specific path to the binary.  If not specified, will
    default to `thrift.exe` on Windows or `thrift` on other systems.

If these properties are not specified on the `Properties` object passed as an
argument, system properties will be checked to see if they are defined there.
Passing null to this method is safe, and is the equivalent of passing an empty
`Properties` object.

For more examples how to invoke the compiler from a Java program, you can
take a look at the [`ThriftCompilerTest`][4] class.

Known Issue(s):
---------------

On Windows, UNC paths probably will not work (i.e., `\\someserver\somefile`).
This is a limitation of NestedVM and is not simple to fix.  A workaround might
be to create a mapped network drive (i.e., `N:\somefile`).

[1]: http://nestedvm.ibex.org/
[2]: https://lists.hcoop.net/pipermail/nestedvm/2014-September/000151.html
[3]: http://thrift.apache.org/docs/BuildingFromSource
[4]: src/test/java/org/apache/thrift/compiler/ThriftCompilerTest.java
